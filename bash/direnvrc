#!/bin/bash

function _scoiatael_maybe_PATH_add() {
    [ -z "$VERBOSE" ] || log_status "Trying dir $1.."
    if test -d $p;
    then
        PATH_add $p
    fi
}

function _scoiatael_launch_gpg_agent() {
  gpgconf --launch gpg-agent

  export SSH_AGENT_SOCK="$(gpgconf --list-dirs agent-ssh-socket)"
}


function _scoiatael_init() {
    [ -z "$VERBOSE" ] || log_status "Start init.."
    export GOPATH=$HOME/Documents/go
    PATH_add $GOPATH/bin

    [ -z "$VERBOSE" ] || log_status "Extending PATH.."
    for p in /usr/local/sbin $HOME/.local/bin $HOME/Library/Python/2.7/bin /usr/local/opt/go/libexec/bin $HOME/.cargo/bin $GOPATH/bin $HOME/dotfiles/bin;
    do
        _scoiatael_maybe_PATH_add $p;
    done

    [ -z "$VERBOSE" ] || log_status "Starting GPG agent.."
    if [ -z "$SSH_AGENT_SOCK" ] && [ -z "$SSH_AUTH_SOCK" ];
    then
        _scoiatael_launch_gpg_agent;
    fi

    [ -z "$VERBOSE" ] || log_status "Loading agent.."
    if ! ssh-add -l | grep -v 'no identities';
    then
        if ! ssh-add -A 2> /dev/null;
        then
            ssh-add
        fi
    fi

    [ -z "$VERBOSE" ] || log_status "Done."
}

_scoiatael_init > /dev/null
